#!/usr/bin/env bash
# -*- bash -*-
#
#
action="$1"
shift
set -u -e -o pipefail

is_running=""
case "$action" in

  "help")
    echo " ====================================================="
    echo ""
    echo " $ instruct_instruct_instruct    watch"
    echo ""
    echo " ====================================================="
    echo ""
    exit 0
    ;;

  "watch")
    echo "=== Watching: "
    inotifywait -e modify -m -r .  | while read CHANGE
    do
      dir=$(echo "$CHANGE" | cut -d' ' -f 1)
      op=$(echo "$CHANGE" | cut -d' ' -f 2)
      file=$(echo "$CHANGE" | cut -d' ' -f 3)
      path="${dir}$file"

      if [[ "$file" == *.js* ]]; then
        if [[ -z "$is_running" ]]; then
          echo ""
          echo "=== Runninig jshint on $path: $CHANGE $is_running"
          is_running="true"
          (jshint "$path" && echo "No errors.") || true
        else
          is_running=""
        fi
      fi

      if [[ "$path" == *bin/* ]]; then
        echo ""
        echo "=== Restarting:"
        exec $path "watch"
      fi
    done
    ;;

  *)
    echo "Unknown option: $action" 1>&2
    exit 1
    ;;

esac # === $action


